import argparse

from sklearn.metrics import roc_auc_score
from keras.models import Model
from keras.layers import Input, Dense
from keras.callbacks import ModelCheckpoint
from ..common import data_reader


class MalwareModel:
    def __init__(self, epochs, batch_size, dense_size, dense_stack_size, data_path):
        self._epochs = epochs
        self._dense_size = dense_size
        self._data_path = data_path
        self._dense_stack_size = dense_stack_size
        self._model = None
        self._data_gen = data_reader.MalwareData(batch_size)
        self._data_gen.setup()

    def build_model(self):
        machine_input = Input((80,), name="input")

        d = Dense(self._dense_size, activation="relu", input_shape=(80,))(machine_input)

        for _ in range(self._dense_stack_size):
            d = Dense(self._dense_size, activation="relu")(d)
        
        # probability of a machine being infected
        probability = Dense(1, activation="sigmoid")(d)
        self._model = Model(inputs=[machine_input], outputs=probability)
        self._model.compile(loss='binary_crossentropy', optimizer='rmsprop')

    def load(self, fname):
        self._model.load_weights(fname)

    def train(self):
        self._model.fit_generator(
            self._data_gen,
            epochs=self._epochs,
            verbose=2,
            callbacks=[
                ModelCheckpoint("model.{epoch:02d}.hdf5")
            ],
        )

    """
    TODO
    * Predict on testset
    """

def main(args):
    model = MalwareModel(args.epochs, args.batch_size, args.dense_size, args.dense_stack_size, args.train_fpath)
    model.build_model()
    if args.load_path:
        model.load(args.load_path)
    if args.train:
        model.train()
    # TODO: if test, then do test..


if __name__ == "__main__":
    description = "Neural Based Machine Infection Classifier"
    parser = argparse.ArgumentParser(description=description)
    parser.add_argument("-t, --train", dest="train", action="store_true")
    parser.add_argument("-te, --test", dest="test", action="store_true")
    parser.add_argument("--train_fpath", dest="train_fpath", nargs=1)
    parser.add_argument("-l, --load_path", dest="load_path", nargs=1)
    parser.add_argument("--test_fpath", dest="test_fpath", nargs=1)
    parser.add_argument("-e, --epochs", dest="epochs", type=int, nargs=1, default=5)
    parser.add_argument("-bs", "--batch_size", dest="batch_size", type=int, nargs=1, default=50)
    parser.add_argument("-ds", "--dense_size", dest="dense_size", type=int, nargs=1, default=512)
    parser.add_argument("-dss, --dense_stack_size", dest="dense_stack_size", type=int, nargs=1, default=3)

    args = parser.parse_args()
    main(args)